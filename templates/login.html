<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login & Signup</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  height: 100vh;
  font-family: 'Poppins', sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  background: url("{{ url_for('static', filename='images/logi.jpg') }}") center/cover no-repeat fixed;
  position: relative;
}
body::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.5);
}
.container {
  position: relative;
  z-index: 1;
  width: 350px;
  padding: 40px;
  border-radius: 20px;
  background: rgba(255,255,255,0.12);
  backdrop-filter: blur(15px);
  text-align: center;
  color: white;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
h2 { margin-bottom: 20px; font-size: 28px; }
input {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 10px;
  border: none;
  background: rgba(255,255,255,0.25);
  color: white;
}
input::placeholder { color: rgba(255,255,255,0.8); }
input:focus { background: rgba(255,255,255,0.35); outline: none; }
button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 10px;
  border: none;
  font-weight: bold;
  color: white;
  background: linear-gradient(90deg,#00DBDE,#FC00FF);
  cursor: pointer;
}
button:disabled { opacity:0.6; cursor:not-allowed; }
.error { color: #ff6961; margin-top: 10px; min-height: 22px; }
.success { color: #00ff99; margin-top: 10px; min-height: 22px; }
#otp-box { display:none; margin-top:10px; }
.switch-link { color:#00f7ff; cursor:pointer; text-decoration:underline; margin-top:10px; display:block; }
</style>
</head>
<body>
<div class="container">
  <h2 id="form-title">Login</h2>
  <form id="authForm" autocomplete="off">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="button" id="authBtn" onclick="handleAuth()">Send OTP / Signup</button>

    <div id="otp-box">
      <input type="text" id="otp" placeholder="Enter 6-digit OTP" maxlength="6" required>
      <button type="button" id="verifyBtn" onclick="verifyOTP()">Verify & Login</button>
    </div>
  </form>
  <p id="msg" class=""></p>
  <span class="switch-link" onclick="toggleForm()">Switch to Signup</span>
</div>

<script>
let isLogin = true;

function toggleForm() {
  isLogin = !isLogin;
  document.getElementById("form-title").innerText = isLogin ? "Login" : "Signup";
  document.getElementById("authBtn").innerText = isLogin ? "Send OTP" : "Signup & Send OTP";
  document.getElementById("otp-box").style.display = "none";
  document.getElementById("msg").innerText = "";
}

async function handleAuth() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const btn = document.getElementById("authBtn");
  const msg = document.getElementById("msg");
  const otpBox = document.getElementById("otp-box");

  if (!email || !password) {
    msg.innerText = "Enter email and password first.";
    msg.className = "error";
    return;
  }

  btn.disabled = true;
  btn.innerText = isLogin ? "Sending OTP..." : "Signing up...";
  msg.innerText = "";

  try {
    const url = isLogin ? "/login" : "/signup";
    const res = await fetch(url, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({email,password})
    });
    const data = await res.json();

    if (!res.ok || !data.success) throw new Error(data.message || "Operation failed");

    msg.innerText = data.message || "OTP sent!";
    msg.className = "success";
    otpBox.style.display = "block";
    document.getElementById("email").readOnly = true;
    document.getElementById("password").readOnly = true;
    btn.style.display = "none";

  } catch(err) {
    msg.innerText = err.message || "Server error.";
    msg.className = "error";
    btn.disabled = false;
    btn.innerText = isLogin ? "Send OTP" : "Signup & Send OTP";
  }
}

async function verifyOTP() {
  const email = document.getElementById("email").value.trim();
  const otp = document.getElementById("otp").value.trim();
  const msg = document.getElementById("msg");

  if (otp.length !== 6) {
    msg.innerText = "Enter a 6-digit OTP.";
    msg.className = "error";
    return;
  }

  try {
    const res = await fetch("/verify_otp", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({email, otp})
    });
    const data = await res.json();

    if (!res.ok || !data.success) throw new Error(data.message || "Invalid OTP");

    msg.innerText = "Login successful!";
    msg.className = "success";
    window.location.href = "/dashboard";
  } catch(err) {
    msg.innerText = err.message || "OTP verification failed.";
    msg.className = "error";
  }
}
</script>
</body>
</html>
